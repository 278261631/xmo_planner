<!doctype html>
{% load static %}
<html>
<head>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no">
      <meta charset="utf-8">
  <title>计划生成</title>
  <link rel="shortcut icon" type="image/png" href="{% static 'favicon.ico' %}"/>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- DataTables -->
  <link rel="stylesheet" href="{% static 'plugins/datatables-bs4/css/dataTables.bootstrap4.min.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/datatables-responsive/css/responsive.bootstrap4.min.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/datatables-buttons/css/buttons.bootstrap4.min.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/datatables-buttons/css/buttons.bootstrap4.min.css' %}">
      <link rel="stylesheet" href="../../plugins/icheck-bootstrap/icheck-bootstrap.min.css">
  <link rel="stylesheet" href="{% static 'plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/fontawesome-free/css/all.min.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/toastr/toastr.min.css' %}">
  <link rel="stylesheet" href="{% static 'dist/css/adminlte.min.css' %}">
</head>
<body class="hold-transition sidebar-mini sidebar-collapse">
<div class="wrapper">
  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <!-- Left navbar links -->
    <ul class="navbar-nav">
{#      <li class="nav-item">#}
{#        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>#}
{#      </li>#}
      <li class="nav-item d-none d-sm-inline-block">
        <a href="#" class="nav-link">Home</a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="#" class="nav-link">Contact</a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <div class="form-group">
            <div class="input-group date" id="req_date_picker" data-target-input="nearest">
                <input type="text" id="req_date" class="form-control datetimepicker-input" data-target="#req_date_picker"/>
                <div class="input-group-append" data-target="#req_date_picker" data-toggle="datetimepicker">
                    <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                </div>
            </div>
        </div>
      </li>
    </ul>

    <!-- Right navbar links -->
    <ul class="navbar-nav ml-auto">

      <!-- Messages Dropdown Menu -->

      <!-- Notifications Dropdown Menu -->
      <li class="nav-item dropdown">
        <a class="nav-link" data-toggle="dropdown" href="#">
          <i class="far fa-bell"></i>
          <span class="badge badge-warning navbar-badge">15</span>
        </a>
        <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
          <span class="dropdown-item dropdown-header">15 Notifications</span>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="fas fa-envelope mr-2"></i> -----
            <span class="float-right text-muted text-sm">3 mins</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="fas fa-users mr-2"></i> =========
            <span class="float-right text-muted text-sm">12 hours</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="fas fa-file mr-2"></i> ========
            <span class="float-right text-muted text-sm">2 days</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item dropdown-footer">See All Notifications</a>
        </div>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-widget="fullscreen" href="#" role="button">
          <i class="fas fa-expand-arrows-alt"></i>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-widget="control-sidebar" data-slide="true" href="#" role="button">
          <i class="fas fa-th-large"></i>
        </a>
      </li>
    </ul>
  </nav>
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4" style="display: none">
    <!-- Brand Logo -->
    <a href="#" class="brand-link">
      <img src="{% static 'dist/img/logo.png' %}" alt="" class="brand-image img-circle elevation-3" style="opacity: .8">
      <span class="brand-text font-weight-light">XMO Planer</span>
    </a>

    <!-- Sidebar -->
    <div class="sidebar">

      <!-- Sidebar Menu -->
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
          <li class="nav-item menu-open">
            <a href="#" class="nav-link active">
              <i class="nav-icon fas fa-table"></i>
              <p>
                列表
                <i class="fas fa-angle-left right"></i>
              </p>
            </a>
            <ul class="nav nav-treeview">
              <li class="nav-item">
                <a href="#" class="nav-link active">
                  <i class="far fa-circle nav-icon"></i>
                  <p>--</p>
                </a>
              </li>
            </ul>
          </li>

        </ul>
      </nav>
      <!-- /.sidebar-menu -->
    </div>
    <!-- /.sidebar -->
  </aside>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-8">
            <div class="card">
{#              <div class="card-header">#}
{#                <h3 class="card-title">aladin 星图</h3>#}
{#              </div>#}
              <!-- /.card-header -->
              <div class="card-body">
                  <div id="aladin-lite-div" style="width: 1000px; height: 800px"></div>
              </div><!-- /.card-body -->
            </div>
            <!-- /.card -->

          </div>
          <!-- /.col -->
        <div class="col-md-4">

            <div class="row">
                <div class="col-md-6">
                    <div class="input-group-append">
                        <label class="col-form-label" for="simple_dec_start_val"><i class="far  fa-arrows-v"></i>开始 dec</label>
                        <input type="text" class="form-control is-warning" id="simple_dec_start_val" placeholder="开始 dec" value="0.0">
                    </div>
                    <div class="input-group-append">
                        <label class="col-form-label" for="simple_dec_end_val"><i class="far  fa-arrows-v"></i>结束 dec</label>
                        <input type="text" class="form-control is-warning" id="simple_dec_end_val" placeholder="结束 dec" value="10.0">
                    </div>
                </div>
                <div class="col-md-2">
                    <button id="simple-jgg-kats-button" class="btn btn-default" data-sysname="kats">
                        <i class="fas fa-check-circle">简易九宫格 KATS</i>
                    </button>

                </div>
            </div>
        </div>

        </div>
        <!-- /.row -->
        <div class="row">
            <div class="col-md-2">
                <div class="input-group-append">
                    <label class="col-form-label" for="x_cen_val"><i class="far fa-flash"></i>RA</label>
                    <input type="text" class="form-control is-warning" id="x_cen_val" placeholder="RA" value="0">
                </div>
            </div>
            <div class="col-md-2">
                <div class="input-group-append">
                    <label class="col-form-label" for="y_cen_val"><i class="far fa-flash"></i>Dec</label>
                    <input type="text" class="form-control is-warning" id="y_cen_val" placeholder="Dec" value="0">
                </div>
            </div>
            <div class="col-md-3">
                <div class="input-group-append">
                  <button id="get-ra-dec-button" class="btn btn-default">
                    <i class="fas fa-unsorted">获取星图 RA Dec （拖拽 双击）星图定位）</i>
                  </button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-2">
                <div class="input-group-append">
                    <label class="col-form-label" for="x_row_val"><i class="far fa-flash"></i>行 row</label>
                    <input type="text" class="form-control is-warning" id="x_row_val" placeholder="行 row" value="3">
                </div>
            </div>
            <div class="col-md-2">
                <div class="input-group-append">
                    <label class="col-form-label" for="y_col_val"><i class="far  fa-arrows-v"></i>列 col</label>
                    <input type="text" class="form-control is-warning" id="y_col_val" placeholder="列 col" value="3">
                </div>
            </div>
            <div class="col-md-2">
                <div class="input-group-append">
                    <label class="col-form-label" for="x_img_val"><i class="far  fa-arrows-v"></i>宽</label>
                    <input type="text" class="form-control is-warning" id="x_img_val" placeholder="宽" value="3.333333334">
                </div>
            </div>
            <div class="col-md-2">
                <div class="input-group-append">
                    <label class="col-form-label" for="y_img_val"><i class="far  fa-arrows-v"></i>高</label>
                    <input type="text" class="form-control is-warning" id="y_img_val" placeholder="高" value="2.216666667">
                </div>
            </div>
            <div class="col-md-2">
                <div class="input-group-append">
                    <label class="col-form-label" for="req_col_max_ra_deg"><i class="far  fa-arrows-v"></i>RA max</label>
                    <input type="text" class="form-control is-warning" id="req_col_max_ra_deg" placeholder="RA max" value="355.0">
                </div>
            </div>
            <div class="col-md-2">
                <div class="input-group-append">
                    <label class="col-form-label" for="req_row_max_dec_deg"><i class="far  fa-arrows-v"></i>Dec max</label>
                    <input type="text" class="form-control is-warning" id="req_row_max_dec_deg" placeholder="Dec max" value="80.0">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-2">
                  <button id="switch-to-kats-button" class="btn btn-default" data-sysname="kats">
                    <i class="fas fa-check-circle">KATS</i>
                  </button>
            </div>
            <div class="col-md-2">
                  <button id="switch-to-east-button" class="btn btn-default" data-sysname="east">
                    <i class="fas fa-check-circle">EAST</i>
                  </button>
            </div>
            <div class="col-md-2">
                  <button id="switch-to-pat-button" class="btn btn-default" data-sysname="pat">
                    <i class="fas fa-check-circle">PAT</i>
                  </button>
            </div>
            <div class="col-md-2">
                  <button id="switch-to-gy7-button" class="btn btn-default" data-sysname="gy7">
                    <i class="fas fa-check-circle">GY7</i>
                  </button>
            </div>
            <div class="col-md-2">
                <input type="checkbox" id="do-generate" data-bootstrap-switch>
            </div>
        </div>
        <div class="row">
            <div class="col-md-2">
                <button id="manual-gen-kats-button" class="btn btn-default" data-sysname="kats">
                    <i class="fas fa-check-circle">手动九宫格 KATS</i>
                </button>
            </div>
        </div>
        <div class="row">
            <div class="col-md-2">
                  <button id="load-from-kats-button" class="btn btn-default">
                    <i class="fas fa-check-circle">加载 KATS</i>
                  </button>
            </div>
            <div class="col-md-2">
                  <button id="load-from-east-button" class="btn btn-default">
                    <i class="fas fa-check-circle">加载 EAST</i>
                  </button>
            </div>
            <div class="col-md-2">
                  <button id="load-from-pat-button" class="btn btn-default">
                    <i class="fas fa-check-circle">加载 PAT</i>
                  </button>
            </div>
            <div class="col-md-2">
                  <button id="load-from-gy7-button" class="btn btn-default">
                    <i class="fas fa-check-circle">加载 GY7</i>
                  </button>
            </div>
            <div class="col-md-2">
                  <button id="load-from-jgg-button" class="btn btn-default">
                    <i class="fas fa-check-circle">加载 jgg</i>
                  </button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="input-group-append">
                    <label class="col-form-label" for="overlap_val"><i class="far fa-bell"></i>重叠量 overlap （度 deg） </label>
                    <input type="text" class="form-control is-warning" id="overlap_val" placeholder="重叠量 overlap （度 deg）" value="0.04">
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="input-group-append">
{#                  <button id="add-marker-button" class="btn btn-default">#}
{#                    <i class="fas fa-check-circle">添加标记点</i>#}
{#                  </button>#}
                    <span class="">&nbsp;&nbsp;</span>
                  <button id="draw-sun-button" class="btn btn-default">
                    <i class="fas fa-check-circle">生成计划（启动后第一次比较慢）</i>
                  </button>
                    <span class="">&nbsp;&nbsp;</span>
                  <button id="draw-jgg-button" class="btn btn-default">
                    <i class="fas fa-check-circle">九宫格（启动后第一次比较慢）</i>
                  </button>
                  <button id="combine-jgg-button" class="btn btn-default">
                    <i class="fas fa-check-circle">拼接九宫格</i>
                  </button>
                    <span class="">&nbsp;&nbsp;</span>
                  <button id="clear-plan-squire-button" class="btn btn-default">
                    <i class="fas fa-check-circle">清除</i>
                  </button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                <div class="input-group-append">
                    <label class="col-form-label" >plan 存放目录：</label>
                    <label id="out-plan-path" class="col-form-label" >-- </label>
                </div>
            </div>
        </div>


        </div><!-- /.container-fluid -->

    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->

  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->
</div>
<!-- ./wrapper -->

<!-- jQuery -->
<script src="{% static 'plugins/jquery/jquery.min.js' %}"></script>
<script src="{% static 'plugins/jquery-validation/jquery.validate.min.js' %}"></script>
<script src="{% static 'plugins/jquery-validation/additional-methods.min.js' %}"></script>
<!-- Bootstrap 4 -->
<script src="{% static 'plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'plugins/bootstrap/js/bootstrap-switch.min.js' %}"></script>
<script src="{% static 'plugins/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>

<script src="{% static 'plugins/toastr/toastr.min.js' %}"></script>
<!-- AdminLTE App -->
<script src="{% static 'dist/js/adminlte.min.js' %}"></script>
<script src="{% static 'plugins/moment/moment.min.js' %}"></script>
<script src="{% static 'plugins/inputmask/jquery.inputmask.min.js' %}"></script>
<script src="{% static 'plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js' %}"></script>
<!-- AdminLTE for demo purposes -->
<script src="{% static 'dist/js/demo.js' %}"></script>
<script type="text/javascript" src="{% static 'skymap/aladin.umd.cjs' %}" charset="utf-8"></script>
<script type="text/javascript">
    let aladin;
    let current_sys_name = 'xmo';
    const dic_sys_name_params = {
        "kats": {"name":"KATS","img_w":"3.33333334","img_h":"2.216666667"},
        "east": {"name":"EAST","img_w":"7.35","img_h":"5.51666667"},
        "pat" : {"name":"PAT" ,"img_w":"1.95","img_h":"1.95"},
        "gy7" : {"name":"GY7" ,"img_w":"3.33333334","img_h":"2.216666667"},
    };
    function getRandomInt(min, max) {
      min = Math.ceil(min);
      max = Math.floor(max);
      return Math.floor(Math.random() * (max - min)) + min; // 不含最大值，含最小值
    }
    function randomHexColor() {
    const hexChars = '0123456789ABCDEF';
    let color = '#';
    for (let i = 0; i < 6; i++) {
        color += hexChars[getRandomInt(0, 15)];  // 随机选择一个十六进制字符
    }
    return color;  // 返回十六进制格式的颜色字符串
}
    function calc_row_col(temp_image_w, temp_image_h){
        {#let temp_image_w = 2.2166666667;#}
        {#let temp_image_h = 3.3333333334;#}
        {#let start_deg = -10.0;#}
       $.getJSON( "clear_session_data", {}
               , function( data ) {
            toastr.warning('准备生成');
       }).fail(function() { toastr.error('服务器错误'); });

        let start_deg = 0.0;
        let end_deg = 85.0;
        let dec_wid = end_deg - start_deg;
        let generate_num_north = Math.floor(dec_wid / temp_image_h) + 1;
        if(generate_num_north % 3 > 0){
            generate_num_north = generate_num_north + 3 - (generate_num_north % 3);
        }
        {#let generate_num_south = Math.floor(10 / temp_image_h);#}
        {#let temp_image_w_rad = temp_image_w * Math.PI / 180;#}

        {#generate_num_north = 4;#}
        for (let i=0;i<generate_num_north;i++){
            let temp_overlap_min = temp_image_w / 200;
            let temp_overlap_max = temp_image_w / 20;
            let temp_overlap_angle_level_deg =  temp_image_h * i;
            let temp_overlap_angle_level_rad =  temp_overlap_angle_level_deg * Math.PI / 180;
            let temp_overlap_using = temp_overlap_min + (temp_overlap_max-temp_overlap_min)*Math.sin(temp_overlap_angle_level_rad) ;
            {#let temp_overlap_using = sin(dec) + temp_overlap_min;#}
            let temp_center_dec = start_deg + (temp_image_h - temp_overlap_using) * i;
            let temp_center_dec_rad = temp_center_dec * Math.PI / 180;
            let temp_row_count = 1;
            let temp_col_count = 1;
            {#temp_col_count = Math.floor(360 / temp_image_w);#}
            let temp_image_w_alpa = temp_image_w * (1 / Math.cos(temp_center_dec_rad))
            {#console.log("cos" +  Math.cos(temp_center_dec_rad)  + "   1 cos" + (1 / Math.cos(temp_center_dec_rad)));#}
            {#console.log("alpa" + temp_center_dec_rad);#}
            temp_col_count = Math.ceil(360 / (temp_image_w_alpa - temp_overlap_using));
            {#temp_col_count = Math.ceil(360 / (temp_image_w - temp_overlap_using));#}
            if(temp_overlap_angle_level_deg > 50 ){
                //高度越高 大圆弧度对应小圆弧度的折损 越多
                temp_col_count = temp_col_count + 1;
            }
            $("#x_img_val").val(temp_image_w);
            $("#y_img_val").val(temp_image_h);
            $("#overlap_val").val(temp_overlap_using);
            $("#x_row_val").val(temp_row_count);
            $("#y_col_val").val(temp_col_count);
            $("#x_cen_val").val(0);
            $("#y_cen_val").val(temp_center_dec);
            {#console.log("i=%{"+i+"}  count["+generate_num_north+"]  弧长对应夹角["+temp_image_w_alpa+"]  dec ["+temp_center_dec+"]");#}
            {#console.log("rad=%{"+temp_center_dec_rad+"} 列数["+temp_col_count+"]   行数["+generate_num_north+"] 重叠【"+temp_overlap_using+"]" );#}
            if($('#do-generate').is(":checked"))
            {
                $("#draw-sun-button").click();
            }

        }

    }
    function calc_row_col_jgg(temp_image_w, temp_image_h){
       $.getJSON( "clear_session_data", {}
               , function( data ) {
            toastr.warning('准备生成');
       }).fail(function() { toastr.error('服务器错误'); });

        let start_deg = 0.0;
        let end_deg = 85.0;
        let dec_wid = end_deg - start_deg;
        let generate_num_north = Math.floor(dec_wid / temp_image_h);
        generate_num_north = (generate_num_north / 3 ) * 3;
        let jgg_row_count = generate_num_north/3;

        for (let i=0;i<jgg_row_count;i++){
            for(let j=0;j<3;j++){
                let temp_center_dec = start_deg + temp_image_h * i + (temp_image_h*(j-1));
                let temp_row_count = 1;
                let temp_col_count = temp_col_count = Math.ceil(360 / temp_image_w);
                //todo 计算中心左右两点的经度差a 用360/a 得到数量
                temp_col_count = (temp_col_count / 3) * 3;

                $("#x_img_val").val(temp_image_w);
                $("#y_img_val").val(temp_image_h);
                $("#overlap_val").val("0");
                $("#x_row_val").val(temp_row_count);
                $("#y_col_val").val(temp_col_count);
                $("#x_cen_val").val(0);
                $("#y_cen_val").val(temp_center_dec);
                {#console.log("i=%{"+i+"}  count["+generate_num_north+"]  弧长对应夹角["+temp_image_w_alpa+"]  dec ["+temp_center_dec+"]");#}
                {#console.log("rad=%{"+temp_center_dec_rad+"} 列数["+temp_col_count+"]   行数["+generate_num_north+"] 重叠【"+temp_overlap_using+"]" );#}
                if($('#do-generate').is(":checked"))
                {
                    $("#draw-sun-button").click();
                }
            }

        }

    }
    function manual_generate_row_col(temp_image_w, temp_image_h){
       $.getJSON( "clear_session_data", {}
               , function( data ) {
            toastr.warning('准备生成');
       }).fail(function() { toastr.error('服务器错误'); });
        let start_deg = 0.0;
        let generate_num_north = 39;
        let overlap_hi_array = [0.003,0.003,0.003,0.003,0.003,0.003,
                                0.003,0.003,0.003,0.003,0.003,0.003,
                                0.003,0.003,0.003,0.003,0.003,0.003,
                                0.003,0.003,0.003,0.003,0.003,0.003,
                                0.003,0.003,0.003,0.003,0.003,0.003,
                                0.003,0.003,0.003,0.003,0.003,0.003,
                                0.003,0.003,0.003
        ];
        let overlap_wid_array = [0.003,0.0055,0.0128,0.0231,0.0405,0.0629,
                                 0.001,0.0347,0.0729,0.0201,0.0705,0.1229,
                                 0.081,0.1460,0.2159,0.0931,0.1773,0.2662,
                                 0.041,0.1495,0.2627,0.0245,0.1615,0.3030,
                                 0.055,0.2260,0.4017,0.1451,0.3585,0.5765,
                                 0.115,0.4015,0.6925,0.1190,0.5282,0.9420,
                                 0.176,0.8485,1.5250
        ];
        let col_array = [108,108,108,108,108,108,
                         105,105,105,102,102,102,
                         99,99,99,93,93,93,
                         84,84,84,75,75,75,
                         66,66,66,57,57,57,
                         45,45,45,33,33,33,
                         21,21,21
        ];
        for (let i=0;i<generate_num_north;i++){
            if(i<15 || i >= 18){
                {#continue;#}
            }
            let temp_overlap_wid_using = overlap_wid_array[i] ;
            let temp_center_dec = start_deg + (temp_image_h - overlap_hi_array[i]) * i;
            let temp_row_count = 1;
            let temp_col_count = col_array[i];
            $("#x_img_val").val(temp_image_w);
            $("#y_img_val").val(temp_image_h);
            $("#overlap_val").val(temp_overlap_wid_using);
            $("#x_row_val").val(temp_row_count);
            $("#y_col_val").val(temp_col_count);
            $("#x_cen_val").val(0);
            $("#y_cen_val").val(temp_center_dec);
            console.log("i=%{"+i+"}  count["+generate_num_north+"] ");
            console.log("rad=%{} 列数["+temp_col_count+"]   行数["+generate_num_north+"] 重叠 w["
                +temp_overlap_wid_using+"] 重叠h [" + overlap_hi_array[i] +"]" );

            $("#draw-sun-button").click();


        }

    }
    function onClickAladin() {
        let raDec = aladin.getRaDec();
        $("#x_cen_val").val(raDec[0]);
        $("#y_cen_val").val(raDec[1]);
        {#console.log("Double clicked at RA: " + raDec[0] + ", Dec: " + raDec[1]);#}
    }
    A.init.then(() => {
        aladin = A.aladin('#aladin-lite-div', {fov: 180, projection: "AIT", fullScreen: false,
            expandLayersControl: false, cooFrame: 'equatorial', showProjectionControl: true,
            showCooGridControl: true, showSimbadPointerControl: true, showCooGrid: true, showShareControl:false,
            showGotoControl:true, target: 'Sun', showContextMenu: true});

        // manage URL parameters
        const searchParams = new URL(document.location).searchParams;
        if (searchParams.has('baseImageLayer')) {
            aladin.setBaseImageLayer(searchParams.get('baseImageLayer'));
        }
        if (searchParams.has('overlayImageLayer')) {
            aladin.setOverlayImageLayer(searchParams.get('overlayImageLayer'));
        }
        if (searchParams.has('cooFrame')) {
            aladin.setFrame(searchParams.get('cooFrame'));
        }
        if (searchParams.has('fov')) {
            aladin.setFoV(parseFloat(searchParams.get('fov')));
        }
        if (searchParams.has('ra') && searchParams.has('dec')) {
            aladin.gotoRaDec(parseFloat(searchParams.get('ra')), parseFloat(searchParams.get('dec')));
        }
        if (searchParams.has('showReticle')) {
            aladin.showReticle(searchParams.get('showReticle')==='true');
        }
        if (searchParams.has('projection')) {
            aladin.setProjection(searchParams.get('projection'));
        }
        if (searchParams.has('showCooGrid')) {
            const b = searchParams.get('showCooGrid') === 'true';
            aladin.view.setGridConfig({
                enabled: b
            });
        }
		
		var overlay = A.graphicOverlay({color: '#ee2345', lineWidth: 2});
        aladin.addOverlay(overlay);
        overlay.add(A.ellipse(10.6833, 41.2669, 3.33333/2, 1.1798333/2, 35));
		overlay.add(A.polyline([ [2.29452158, 59.14978110], [10.12683778, 56.53733116], [14.1772154, 60.7167403], [21.45396446, 60.23528403], [28.59885697, 63.67010079] ]));
		overlay.add(A.polyline([ [165.929, 61.75],[165.45, 56.38],[178.45, 53.69],[183.85 , 57.032],[193.50 , 55.959],[200.98 , 54.925],[206.88 , 49.313]]));
		

		var marker1 = A.marker(0.1, 89.9, {popupTitle: '0.1 89.9', popupDesc: 'Object type: Pulsar'});
		var marker2 = A.marker(1, 89, {popupTitle: 'HD 164514', popupDesc: 'Object type: Star in cluster'});
		var marker3 = A.marker(0, 90, {popupTitle: '0  90', popupDesc: 'Object type: Double star'});
		var markerLayer = A.catalog({name: 'Some markers', sourceSize: 18,color: '#ffff11'});
		aladin.addCatalog(markerLayer);
		markerLayer.addSources([ marker3]);

        aladin.on('click', onClickAladin);

    });
    $(document).ready(function() {
        console.log({{ req_date }})
        const default_req_date = moment({{ req_date }},'YYYYMMDD');
        // $('#table_tele_sys').dataTable({"paging": false});
        $('#req_date_picker').datetimepicker({
          format: "yyyyMMDD",
           defaultDate: default_req_date,
          singleDatePicker: true,
        });
       $("#req_date_picker").on("change.datetimepicker", ({date, oldDate}) => {
         let req_date_url;
         if (oldDate !== null) {
           req_date_url = $("#req_date").val();
           console.log(req_date_url);
           window.location.href = "/dashboard?req_date="+req_date_url;
         }
        });


       $('#draw-sun-button').on('click', function () {
          $('#out-plan-path').text('----');
          let ex_message_ser = '';
          {#$.getJSON( "draw_sun", {req_overlap_deg:$("overlap_val").val()}#}
          let overlap_temp = $("#overlap_val").val();
          let x_row_temp = $("#x_row_val").val();
          let y_col_temp = $("#y_col_val").val();
          let x_img_temp = $("#x_img_val").val();
          let y_img_temp = $("#y_img_val").val();
          let x_cen_temp = $("#x_cen_val").val();
          let y_cen_temp = $("#y_cen_val").val();
          console.log("sys_name: " + current_sys_name)
          $.getJSON( "draw_sun", {req_overlap_deg:overlap_temp, req_row_int:x_row_temp, req_col_int:y_col_temp,
              req_x_img_deg:x_img_temp, req_y_img_deg:y_img_temp,req_ra_deg:x_cen_temp,req_dec_deg:y_cen_temp,
              req_sys_name:current_sys_name,
              }
            , function( data ) {
              console.log(data);
			let marker_sun = A.marker(data.sun_ra, data.sun_dec, {popupTitle: '太阳', popupDesc: '--'});
			let markerLayer_sun = A.catalog({name: '太阳', sourceSize: 18,color: '#ffAA11'});
			aladin.addCatalog(markerLayer_sun);
			markerLayer_sun.addSources([marker_sun]);

			let marker_moon = A.marker(data.moon_ra, data.moon_dec, {popupTitle: '月亮', popupDesc: '--'});
			let markerLayer_moon = A.catalog({name: '月', sourceSize: 18,color: '#AAAAAA'});
			aladin.addCatalog(markerLayer_moon);
			markerLayer_moon.addSources([marker_moon]);

            let sun_curve = data.sun_curve;
            let markers_sun = [];
            for (let i = 0; i < sun_curve.length; i++) {
			  let marker_sun_temp = A.marker(sun_curve[i][0], sun_curve[i][1], {popupTitle: '', popupDesc: ''});
              markers_sun.push(marker_sun_temp)
            }
			let markerLayer_sun_curve = A.catalog({name: '--', sourceSize: 8,color: '#FFAA11'});
			aladin.addCatalog(markerLayer_sun_curve);
			markerLayer_sun_curve.addSources(markers_sun);

            let moon_curve = data.moon_curve;
            let markers_moon = [];
            for (let i = 0; i < moon_curve.length; i++) {
			  let marker_moon_temp = A.marker(moon_curve[i][0], moon_curve[i][1], {popupTitle: '', popupDesc: ''});
              markers_moon.push(marker_moon_temp)
            }
			let markerLayer_moon_curve = A.catalog({name: '-', sourceSize: 8,color: '#AAAAAA'});
			aladin.addCatalog(markerLayer_moon_curve);
			markerLayer_moon_curve.addSources(markers_moon);

            {#return;#}
            let plan_area = data.areas;
            let overlay_areas = A.graphicOverlay({name: 'areas', color: '#8ebd84', lineWidth: 1});
            aladin.addOverlay(overlay_areas);
            for(let i = 0; i < plan_area.length; i++){
                {#console.log(plan_area[i]);#}
                {#let overlay_areas = A.graphicOverlay({name: 'a_'+i, color: '#8ebd84', lineWidth: 2});#}
                {#aladin.addOverlay(overlay_areas);#}
              //  overlay_areas.addFootprints([A.polygon(plan_area[i])]);

                {#for(let j=0; j<plan_area[i].length; j++ ){#}
                {#    let marker_cor = A.marker(plan_area[i][j][0], plan_area[i][j][1], {popupTitle: 'Cen', popupDesc: plan_area[i][j][0]+'  '+plan_area[i][j][1]});#}
                {#    let markerLayer_cor = A.catalog({name: 'Center', sourceSize: 14,color: '#a606f8'});#}
                {#    aladin.addCatalog(markerLayer_cor);#}
                {#    markerLayer_cor.addSources([marker_cor]);#}
                {#    console.log(plan_area[i][j][0])#}
                {#    console.log(plan_area[i][j][1])#}
                {##}
                {# }#}
            }


			{#let marker_cen = A.marker(data.center_ra, data.center_dec, {popupTitle: 'Cen', popupDesc: data.center_ra+'  '+data.center_dec});#}
			{#let markerLayer_cen = A.catalog({name: 'Center', sourceSize: 10,color: '#cc00ff'});#}
            {##}
            {#let centers_data = data.centers;#}
            //for(let i = 0; i < centers_data.length; i++) {
                {#let marker_cen_item = A.marker(centers_data[i][0], centers_data[i][1], {popupTitle: 'Cen', popupDesc: centers_data[i][0]+'  '+centers_data[i][1]});#}
                {#markerLayer_cen.addSources([marker_cen_item]);#}
            //}

			{#aladin.addCatalog(markerLayer_cen);#}
			{#markerLayer_cen.addSources([marker_cen]);#}
            console.log(data.center_ra)
            console.log(data.center_dec)

            ex_message_ser = data.ex_message;
            toastr.success('结果数目： ' +data.areas.length);
            $('#out-plan-path').text(data.out_path.replace('\\','/'));
            if(ex_message_ser.length > 0){
              toastr.warning(ex_message_ser);
            }

          }).fail(function() { toastr.error('服务器错误'); })


       });

       $('#draw-jgg-button').on('click', function () {
          $('#out-plan-path').text('----');
          let ex_message_ser = '';
          let overlap_temp = $("#overlap_val").val();
          let x_row_temp = $("#x_row_val").val();
          let y_col_temp = $("#y_col_val").val();
          let x_img_temp = $("#x_img_val").val();
          let y_img_temp = $("#y_img_val").val();
          let x_cen_temp = $("#x_cen_val").val();
          let y_cen_temp = $("#y_cen_val").val();
          let col_max_ra_deg_temp = $("#req_col_max_ra_deg").val();
          let row_max_dec_deg_temp = $("#req_row_max_dec_deg").val();
          console.log("sys_name: " + current_sys_name)
          $.getJSON( "draw_all_sky_by_jgg", {req_overlap_deg:overlap_temp, req_row_int:x_row_temp, req_col_int:y_col_temp,
              req_x_img_deg:x_img_temp, req_y_img_deg:y_img_temp,req_ra_deg:x_cen_temp,req_dec_deg:y_cen_temp,
              req_sys_name:current_sys_name,req_col_max_ra_deg:col_max_ra_deg_temp,req_row_max_dec_deg:row_max_dec_deg_temp,
              }, function( data ) {
              console.log(data);

            let plan_area = data.areas;
            let overlay_areas = A.graphicOverlay({name: 'areas', color: '#8ebd84', lineWidth: 1});
            aladin.addOverlay(overlay_areas);
            for(let i = 0; i < plan_area.length; i++){
                {#console.log(plan_area[i]);#}
                {#let overlay_areas = A.graphicOverlay({name: 'a_'+i, color: '#8ebd84', lineWidth: 2});#}
                {#aladin.addOverlay(overlay_areas);#}
                overlay_areas.addFootprints([A.polygon(plan_area[i])]);

                {#for(let j=0; j<plan_area[i].length; j++ ){#}
                {#    let marker_cor = A.marker(plan_area[i][j][0], plan_area[i][j][1], {popupTitle: 'Cen', popupDesc: plan_area[i][j][0]+'  '+plan_area[i][j][1]});#}
                {#    let markerLayer_cor = A.catalog({name: 'Center', sourceSize: 14,color: '#a606f8'});#}
                {#    aladin.addCatalog(markerLayer_cor);#}
                {#    markerLayer_cor.addSources([marker_cor]);#}
                {#    console.log(plan_area[i][j][0])#}
                {#    console.log(plan_area[i][j][1])#}
                {##}
                {# }#}
            }


			let marker_cen = A.marker(data.center_ra, data.center_dec, {popupTitle: 'Cen', popupDesc: data.center_ra+'  '+data.center_dec});
			let markerLayer_cen = A.catalog({name: 'Center', sourceSize: 10,color: '#cc00ff'});

            let centers_data = data.centers;
            for(let i = 0; i < centers_data.length; i++) {
                let marker_cen_item = A.marker(centers_data[i][0], centers_data[i][1], {popupTitle: 'Cen', popupDesc: centers_data[i][0]+'  '+centers_data[i][1]});
                markerLayer_cen.addSources([marker_cen_item]);
            }

			aladin.addCatalog(markerLayer_cen);
			markerLayer_cen.addSources([marker_cen]);
            console.log(data.center_ra)
            console.log(data.center_dec)

            ex_message_ser = data.ex_message;
            toastr.success('结果数目： ' +data.areas.length);
            $('#out-plan-path').text(data.out_path.replace('\\','/'));
            if(ex_message_ser.length > 0){
              toastr.warning(ex_message_ser);
            }

          }).fail(function() { toastr.error('服务器错误'); })


       });

       $("#overlap_val").on("input", function () {
          let inputValue = $(this).val();
          // 使用正则表达式进行校验 小数数字输入
          let regex = /^[0-9]+(\.[0-9]+)?$/;
          $(this).removeClass("is-warning");
          if (regex.test(inputValue)) {
          $(this).removeClass("is-invalid").addClass("is-valid");
          console.log("输入合法");
          } else {
            $(this).removeClass("is-valid").addClass("is-invalid");
              console.log("输入不合法");
          }
      });
       $("#get-ra-dec-button").on("click",function (){
         onClickAladin();
       });
       $("#clear-plan-squire-button").on("click",function (){
         aladin.removeLayers();
       });
       $("#aladin-lite-div").on("dblclick",function (){
         onClickAladin();
       });
       $("#switch-to-kats-button").on("click",function (){
            current_sys_name = $('#switch-to-kats-button').data('sysname');
            calc_row_col(dic_sys_name_params["kats"]["img_w"], dic_sys_name_params["kats"]["img_h"]);
       });
       $("#manual-gen-kats-button").on("click",function (){
            current_sys_name = $('#switch-to-kats-button').data('sysname');
            manual_generate_row_col(dic_sys_name_params["kats"]["img_w"], dic_sys_name_params["kats"]["img_h"]);
       });
       $("#switch-to-east-button").on("click",function (){
            current_sys_name = $('#switch-to-east-button').data('sysname');
            calc_row_col(dic_sys_name_params["east"]["img_w"], dic_sys_name_params["east"]["img_h"]);
       });
       $("#switch-to-pat-button").on("click",function (){
            current_sys_name = $('#switch-to-pat-button').data('sysname');
            calc_row_col(dic_sys_name_params["pat"]["img_w"], dic_sys_name_params["pat"]["img_h"]);
       });
       $("#switch-to-gy7-button").on("click",function (){
            current_sys_name = $('#switch-to-gy7-button').data('sysname');
            calc_row_col(dic_sys_name_params["gy7"]["img_w"], dic_sys_name_params["gy7"]["img_h"]);
       });
       $("#load-from-kats-button").on("click",function (){
          let overlap_temp = $("#overlap_val").val();
          let x_row_temp = $("#x_row_val").val();
          let y_col_temp = $("#y_col_val").val();
          let x_img_temp = $("#x_img_val").val();
          let y_img_temp = $("#y_img_val").val();
          let x_cen_temp = $("#x_cen_val").val();
          let y_cen_temp = $("#y_cen_val").val();
           $.getJSON( "draw_load_plan", {req_overlap_deg:overlap_temp, req_row_int:x_row_temp, req_col_int:y_col_temp,
              req_x_img_deg:x_img_temp, req_y_img_deg:y_img_temp,req_ra_deg:x_cen_temp,req_dec_deg:y_cen_temp}
               , function( data ) {

            let plan_area = data.areas;
            let overlay_areas = A.graphicOverlay({name: 'areas', color: '#00a0f8', lineWidth: 1});
            aladin.addOverlay(overlay_areas);
            console.log("len:  " + plan_area.length)
            for(let i = 0; i < plan_area.length; i++){
                overlay_areas.addFootprints([A.polygon(plan_area[i])]);
            }

          }).fail(function() { toastr.error('服务器错误'); });
       });
       $("#load-from-jgg-button").on("click",function (){
          let overlap_temp = $("#overlap_val").val();
          let x_row_temp = $("#x_row_val").val();
          let y_col_temp = $("#y_col_val").val();
          let x_img_temp = $("#x_img_val").val();
          let y_img_temp = $("#y_img_val").val();
          let x_cen_temp = $("#x_cen_val").val();
          let y_cen_temp = $("#y_cen_val").val();
           $.getJSON( "draw_load_jgg_plan", {req_overlap_deg:overlap_temp, req_row_int:x_row_temp, req_col_int:y_col_temp,
              req_x_img_deg:x_img_temp, req_y_img_deg:y_img_temp,req_ra_deg:x_cen_temp,req_dec_deg:y_cen_temp}
               , function( data ) {
            let plan_area_jgg = data.areas_jgg;
            console.log("len:  " + plan_area_jgg.length)
            for(let i = 0; i < plan_area_jgg.length; i++){
                let jgg_item = plan_area_jgg[i];
                let overlay_areas = A.graphicOverlay({name: 'areas', color: randomHexColor(), lineWidth: 1});
                aladin.addOverlay(overlay_areas);
                console.log("len:  " + jgg_item.length)
                for(let j = 0; j < jgg_item.length; j++){
                    overlay_areas.addFootprints([A.polygon(jgg_item[j])]);
                }
            }
            toastr.success('结果数目： ' +plan_area_jgg.length);
          }).fail(function() { toastr.error('服务器错误'); });
       });
       $("#combine-jgg-button").on("click",function (){
          let overlap_temp = $("#overlap_val").val();
          let x_row_temp = $("#x_row_val").val();
          let y_col_temp = $("#y_col_val").val();
          let x_img_temp = $("#x_img_val").val();
          let y_img_temp = $("#y_img_val").val();
          let x_cen_temp = $("#x_cen_val").val();
          let y_cen_temp = $("#y_cen_val").val();
           $.getJSON( "generate_jgg_from_session", {req_overlap_deg:overlap_temp, req_row_int:x_row_temp, req_col_int:y_col_temp,
              req_x_img_deg:x_img_temp, req_y_img_deg:y_img_temp,req_ra_deg:x_cen_temp,req_dec_deg:y_cen_temp}
               , function( data ) {

            let plan_area_jgg = data.areas_jgg;
            console.log("len:  " + plan_area_jgg.length)
            for(let i = 0; i < plan_area_jgg.length; i++){
                let jgg_item = plan_area_jgg[i];
                let overlay_areas = A.graphicOverlay({name: 'areas', color: randomHexColor(), lineWidth: 1});
                aladin.addOverlay(overlay_areas);
                console.log("len:  " + jgg_item.length)
                for(let j = 0; j < jgg_item.length; j++){
                    overlay_areas.addFootprints([A.polygon(jgg_item[j])]);
                }
            }

		   let markerLayer_cen = A.catalog({name: 'Center', sourceSize: 10,color: '#88a1fd'});
           for(let i = 0; i < data.centers_jgg.length; i++){
                let centers_data = data.centers_jgg[i];
                {#console.log(centers_data);#}
                for(let i = 0; i < centers_data.length; i++) {
                    let marker_cen_item = A.marker(centers_data[i][0], centers_data[i][1], {popupTitle: 'Cen', popupDesc: centers_data[i][0]+'  '+centers_data[i][1]});
                    markerLayer_cen.addSources([marker_cen_item]);
                }
           }
			aladin.addCatalog(markerLayer_cen);

          }).fail(function() { toastr.error('服务器错误'); });
       });

       $("#simple-jgg-kats-button").on("click",function (){
        $("#x_img_val").val(dic_sys_name_params["gy7"]["img_w"]);
        $("#y_img_val").val(dic_sys_name_params["gy7"]["img_h"]);
          let dec_start_temp = $("#simple_dec_start_val").val();
          let dec_end_temp = $("#simple_dec_end_val").val();
          let x_img_temp = dic_sys_name_params["gy7"]["img_w"];
          let y_img_temp = dic_sys_name_params["gy7"]["img_h"];
          current_sys_name = $('#switch-to-gy7-button').data('sysname');
          toastr.warning('准备生成');
           $.getJSON( "draw_simple_jgg_plan", {req_dec_start_deg:dec_start_temp, req_dec_end_deg:dec_end_temp,
              req_x_img_deg:x_img_temp, req_y_img_deg:y_img_temp,req_sys_name:current_sys_name}
               , function( data ) {

            let plan_area_jgg = data.areas_jgg;
            console.log("len:  " + plan_area_jgg.length)
            for(let i = 0; i < plan_area_jgg.length; i++){
                let jgg_item = plan_area_jgg[i];
                let overlay_areas = A.graphicOverlay({name: 'areas', color: randomHexColor(), lineWidth: 1});
                aladin.addOverlay(overlay_areas);
                console.log("len:  " + jgg_item.length)
                for(let j = 0; j < jgg_item.length; j++){
                    overlay_areas.addFootprints([A.polygon(jgg_item[j])]);
                }
            }
            toastr.success('结果数目： ' +plan_area_jgg.length);
            $('#out-plan-path').text(data.out_path.replace('\\','/'));
          }).fail(function() { toastr.error('服务器错误'); });
       });
        $("input[data-bootstrap-switch]").each(function(){
          $(this).bootstrapSwitch('state', $(this).prop('checked'));
        })
    });

</script>

</body>
</html>
